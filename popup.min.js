"use strict";function Popup(){if(this.id=void 0,this.properties=arguments[0],!this.properties||!(this.properties.constructor===Object&&Object.keys(this.properties).length>0))throw new Error("Popup: empty properties",this.properties);if(this.effect="default",this.type="string"==typeof this.properties?"alert":"default",this.sourceType=void 0,this.autoshow="alert"==this.type?!0:!1,this.width=void 0,this.initiators=[],this.noLayerClick=!1,this.noEscPress=!1,this.containerClass=void 0,this.scope={},this.content={title:void 0,body:"alert"==this.type&&"string"==typeof this.properties?this.properties:void 0},this.ajaxParams={method:void 0,data:void 0,url:void 0,toJSON:!1},this.log=!0,this.buttonsText={ok:void 0,yes:void 0,no:void 0},"object"==typeof this.properties){for(this.scope.key in this.properties)"object"==typeof this.properties[this.scope.key]&&0==Object.keys(this.properties[this.scope.key]).length||"string"==typeof this.properties[this.scope.key]&&0==this.properties[this.scope.key].length||(this[this.scope.key]=this.properties[this.scope.key]);delete this.scope.key}if(this.buttons={close:window.PopupManager.buttons.close,ok:document.createElement("button"),yes:document.createElement("button"),no:document.createElement("button")},this.buttonsText.ok=this.buttonsText.ok||"OK",this.buttonsText.yes=this.buttonsText.yes||"Confirm",this.buttonsText.no=this.buttonsText.no||"Cancel",this.buttons.ok.innerHTML=this.buttonsText.ok,this.buttons.yes.innerHTML=this.buttonsText.yes,this.buttons.no.innerHTML=this.buttonsText.no,this.buttons.ok.onclick=this.onokay.bind(this),this.buttons.yes.onclick=this.onaccept.bind(this),this.buttons.no.onclick=this.ondecline.bind(this),this.elements=window.PopupManager.elements,void 0===this.elements.parent&&(this.elements.parent=document.body),"string"==typeof this.effect&&(this.elements.layer.className+=" "+this.effect,this.elements.container.className+=" "+this.effect),this.elements.buttons.className="buttons",void 0===this.id){for(this.scope.existingId=Object.keys(window.PopupManager.objects),this.scope.i=this.scope.existingId.length;this.scope.i>=0;this.scope.i++)if(this.scope.randomId="popup_"+this.scope.i,-1==this.scope.existingId.indexOf(this.scope.randomId)){this.id=this.scope.randomId;break}delete this.scope.existingId,delete this.scope.randomId,delete this.scope.i}if(window.PopupManager.objects[this.id]=this,this.log&&console.debug("Popup#"+this.id+"->constructor",this.properties),this.initiators.length>0&&this.initiators.forEach(function(a){a.onclick=this.show.bind(this)}.bind(this)),this.ajaxParams.toJSON?this.ajaxParams.method="POST":"GET"!=this.ajaxParams.method&&"POST"!=this.ajaxParams.method?this.ajaxParams.method="GET":this.ajaxParams.method&&(this.ajaxParams.method=this.ajaxParams.method.toUpperCase()),void 0!==this.ajaxParams.url&&void 0===this.sourceType&&(this.sourceType="url"),"dom"==this.sourceType||this.content.body instanceof HTMLElement){if(!(this.content.body instanceof HTMLElement))throw new Error("Popup#"+this.id+'->constructor: property "content.body" must be HTMLElement');"dom"==this.sourceType,this.content.body.parentNode.removeChild(this.content.body)}this.loader=new XMLHttpRequest,this.isActive=!1,this.isContentLoaded=!1,this.onready(),this.autoshow&&this.show()}window.PopupManager={elements:{parent:void 0,container:document.createElement("div"),layer:document.createElement("div"),title:document.createElement("div"),buttons:document.createElement("div")},buttons:{close:document.createElement("button")},objects:{},scope:{},autocallElements:{},current:void 0,destroy:function(){for(this.scope.id in window.PopupManager.objects)window.PopupManager.objects[id].destroy();delete window.PopupManager}},window.PopupManager.constructor=function(){this.elements.layer.className="popupLayer",this.elements.container.className="popupContent",this.buttons.close.className="popupClose",this.buttons.close.innerHTML="â•³",this.buttons.close.onclick=function(){window.PopupManager.objects[window.PopupManager.current].hide()},this.elements.container.appendChild(document.createElement("div")),this.elements.container.appendChild(this.buttons.close),this.elements.title.className="title"},Popup.prototype.resize=function(){window.PopupManager.objects[window.PopupManager.current].elements.container.style.height=window.PopupManager.objects[window.PopupManager.current].elements.container.childNodes[0].offsetHeight+"px"},Popup.prototype.keyup=function(a){void 0===window.PopupManager.current||27!=a.keyCode||window.PopupManager.objects[window.PopupManager.current].noEscPress||window.PopupManager.objects[window.PopupManager.current].hide()},Popup.prototype.getContent=function(a){if(void 0===this.ajaxParams.url)throw new Error("Popup#"+this.id+"->getContent: no url");void 0!==this.ajaxParams.data&&this.ajaxParams.data.constructor===Object&&(this.ajaxParams.toJSON?this.scope.prepared=JSON.stringify(this.ajaxParams.data):(this.scope.prepared="",Object.keys(this.ajaxParams.data).forEach(function(a,b){this.scope.prepared+=(0!=b?"&":"")+a+"="+this.ajaxParams.data[a]}.bind(this)))),"GET"==this.ajaxParams.method?(this.scope.url=this.ajaxParams.url,this.scope.prepared&&(this.scope.url=this.ajaxParams.url+(-1==this.ajaxParams.url.indexOf("?")?"?"+this.scope.prepared:"&"+this.scope.prepared)),this.loader.open(this.ajaxParams.method,this.scope.url,!0),this.loader.send(),delete this.scope.url):"POST"==this.ajaxParams.method&&(this.loader.open(this.ajaxParams.method,this.ajaxParams.url+(-1==this.ajaxParams.url.indexOf("?")?"?r="+(new Date).getTime():""),!0),this.ajaxParams.toJSON?this.loader.setRequestHeader("Content-type","application/json"):this.loader.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.loader.send(void 0===this.scope.prepared?null:this.scope.prepared)),delete this.scope.prepared,this.loader.onreadystatechange=function(){if(4==this.loader.readyState){if(200!=this.loader.status)throw new Error("Popup#"+this.id+"->getContent: ",this.loader.responseText);this.log&&console.debug("Popup#"+this.id+"->getContent"),this.content.body=this.loader.responseText,this.isContentLoaded=!0,a instanceof Function&&a.call(this)}}.bind(this)},Popup.prototype.show=function(){return this.elements.parent.className="locked",this.elements.parent.appendChild(this.elements.layer),"url"==this.sourceType&&this.isContentLoaded===!1?(this.getContent(this.show),!1):(this.log&&console.debug("Popup#"+this.id+"->show"),window.PopupManager.current=this.id,this.elements.parent.appendChild(this.elements.container),this.elements.layer.onclick=function(){this.noLayerClick===!1&&this.hide()}.bind(this),"string"==typeof this.content.body?this.elements.container.children[0].innerHTML="alert"==this.type||"confirm"==this.type?'<div class="simple">'+this.content.body+"</div>":this.content.body:"object"==typeof this.content.body&&this.elements.container.children[0].appendChild(this.content.body),this.elements.container.className+=void 0!==this.containerClass?" "+this.containerClass:"",void 0!==this.content.title&&(this.content.title instanceof HTMLElement?this.elements.title.appendChild(this.content.title):this.elements.title.innerHTML=this.content.title,this.elements.container.childNodes[0].insertBefore(this.elements.title,this.elements.container.childNodes[0].childNodes[0])),("alert"==this.type||"confirm"==this.type)&&this.elements.container.childNodes[0].appendChild(this.elements.buttons),"alert"==this.type?this.elements.buttons.appendChild(this.buttons.ok):"confirm"==this.type&&(this.elements.buttons.appendChild(this.buttons.yes),this.elements.buttons.appendChild(this.buttons.no)),void 0!==this.width&&(this.elements.container.style.width=this.width+"px"),"url"==this.sourceType&&this.parseJS(this.elements.container),setTimeout(function(){this.elements.layer.className+=" visible",this.elements.container.className=this.elements.container.className+" visible"}.bind(this),0),window.addEventListener("resize",this.resize),document.addEventListener("keyup",this.keyup),this.isActive=!0,this.onshow(),void this.resize())},Popup.prototype.hide=function(){this.log&&console.debug("Popup#"+this.id+"->hide"),this.elements.container.className=this.elements.container.className.replace("visible","").trim(),this.elements.layer.className=this.elements.layer.className.replace("visible","").trim(),window.removeEventListener("resize",this.resize),document.removeEventListener("keyup",this.keyup),this.isActive=!1,setTimeout(function(){this.elements.parent.removeAttribute("class"),void 0!==this.width&&(this.elements.container.style.width=""),"string"==typeof this.content.body?this.elements.container.childNodes[0].innerHTML="":"object"==typeof this.content.body&&this.elements.container.childNodes[0].removeChild(this.content.body),void 0!==this.content.title&&(this.elements.title.innerHTML=""),this.elements.buttons.innerHTML="",this.elements.container.parentNode.removeChild(this.elements.container),this.elements.layer.onclick=null,this.elements.layer.parentNode.removeChild(this.elements.layer),window.PopupManager.current=void 0,this.onhide(),"alert"!=this.type&&"confirm"!=this.type||0!=this.initiators.length||this.destroy()}.bind(this),700)},Popup.prototype.update=function(){this.log&&console.debug("Popup#"+this.id+"->update"),this.initiators.forEach(function(a){null===a.parentNode?(a.onclick=null,this.initiators.splice(this.initiators.indexOf(a),1)):null===a.onclick&&(a.onclick=this.show.bind(this))}.bind(this))},Popup.prototype.parseJS=function(){this.log&&console.debug("Popup#"+this.id+"->parseJS"),[].forEach.call(this.elements.container.querySelectorAll("script"),function(item){null!==item.getAttribute("src")?(this.loader.open("POST",item.src,!0),this.loader.send(),this.loader.onreadystatechange=function(){if(4==this.loader.readyState){if(200!=this.loader.status)throw new Error("Popup#"+this.id+"->parseJS: can't get script file");eval(this.loader.responseText)}}):eval(item.innerText?item.innerText:item.innerHTML?item.innerHTML:item)}.bind(this))},Popup.prototype.onready=function(){},Popup.prototype.onshow=function(){},Popup.prototype.onhide=function(){},Popup.prototype.onokay=Popup.prototype.hide,Popup.prototype.onaccept=Popup.prototype.hide,Popup.prototype.ondecline=Popup.prototype.hide,Popup.prototype.destroy=function(){this.log&&console.debug("Popup#"+this.id+"->destroy"),Object.keys(this.buttons).forEach(function(a){"close"!==a&&(this.buttons[a].onclick=null)}.bind(this)),delete this.content,delete window.PopupManager.objects[this.id]},window.PopupManager.constructor();